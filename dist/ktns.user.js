// ==UserScript==
// @name        ktns
// @version     1.0.0
// @author      jonrhall
// @description A kittens visualization engine
// @match       http://bloodrizer.ru/games/kittens/
// @namespace   https://github.com/jonrhall
// @grant       GM_addStyle
// @require     https://d3js.org/d3.v3.min.js
// @require     https://gist.githubusercontent.com/jonrhall/9fb5f6f0a820763704c6635e57602eb5/raw/6eb742223b9795260ba62150196ed0ae4a461e39/bullet.js
// ==/UserScript==

!function(e){var t={};function n(r){if(t[r])return t[r].exports;var l=t[r]={i:r,l:!1,exports:{}};return e[r].call(l.exports,l,l.exports,n),l.l=!0,l.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var l in e)n.d(r,l,function(t){return e[t]}.bind(null,l));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";n.r(t);const r={positive:"green",negative:"red",text:"#bbb",highlight:"white",marker:"red"};GM_addStyle(`\n  #ktns-button {\n    position: absolute;\n    bottom: 3rem;\n    right: 2rem;\n    width: 50px;\n    height: 50px;\n    border-radius: 30px;\n    cursor: pointer;\n    border:1px solid #495267; display:inline-block;text-shadow: -1px -1px 0 rgba(0,0,0,0.3);\n    background-color: #606c88; background-image: -webkit-gradient(linear, left top, left bottom, from(#606c88), to(#3f4c6b));\n    background-image: -webkit-linear-gradient(top, #606c88, #3f4c6b);\n    background-image: -moz-linear-gradient(top, #606c88, #3f4c6b);\n    background-image: -ms-linear-gradient(top, #606c88, #3f4c6b);\n    background-image: -o-linear-gradient(top, #606c88, #3f4c6b);\n    background-image: linear-gradient(to bottom, #606c88, #3f4c6b);filter:progid:DXImageTransform.Microsoft.gradient(GradientType=0,startColorstr=#606c88, endColorstr=#3f4c6b);\n  }\n\n  #ktns-button:hover {\n    border:1px solid #363d4c;\n    background-color: #4b546a; background-image: -webkit-gradient(linear, left top, left bottom, from(#4b546a), to(#2c354b));\n    background-image: -webkit-linear-gradient(top, #4b546a, #2c354b);\n    background-image: -moz-linear-gradient(top, #4b546a, #2c354b);\n    background-image: -ms-linear-gradient(top, #4b546a, #2c354b);\n    background-image: -o-linear-gradient(top, #4b546a, #2c354b);\n    background-image: linear-gradient(to bottom, #4b546a, #2c354b);filter:progid:DXImageTransform.Microsoft.gradient(GradientType=0,startColorstr=#4b546a, endColorstr=#2c354b);\n  }\n\n  #ktns-button img {\n    position: relative;\n    left: 9px;\n    top: 9px;\n  }\n\n  #ktns-hook {\n    position: absolute;\n    bottom: 7rem;\n    right: 5rem;\n    padding: 1rem 0;\n    border: 1px solid #737373;\n    background-color: #1a1815;\n    font-family: "Arial", sans-serif;\n    width: 400px;\n    overflow: hidden;\n    display: none;\n  }\n\n  #ktns-hook.active {\n    display: block;\n  }\n\n  .bullet { font: 10px sans-serif; }\n  .bullet .marker { stroke: transparent; stroke-width: 2px; transition: stroke 0.2s; transition-delay: 0.4s  }\n  .bullet .marker.selected { stroke: ${r.marker}; transition: stroke 0.2s; }\n  .bullet .tick line { stroke: #666; stroke-width: .5px; }\n  .bullet .tick text { fill: ${r.text}; }\n  .bullet:hover .tick text, .bullet.selected .tick text { fill: ${r.highlight}; }\n  .bullet .range.s0 { fill: #eee; }\n  .bullet .range.s1 { fill: #c9c9c9; }\n  .bullet .range.s2 { fill: #a2a2a2; }\n  .bullet .measure.s0 { fill: lightsteelblue; }\n  .bullet .measure.s1 { fill: steelblue; }\n  .bullet .title { font-size: 14px; font-weight: bold; fill: ${r.text}; letter-spacing: 0.5px; }\n  .bullet:hover .title, .bullet.selected .title { fill: ${r.highlight}; }\n  .bullet .subtitle { fill: ${r.text}; }\n  .bullet:hover .subtitle, .bullet.selected .subtitle { fill: ${r.highlight}; }\n`);var l={colors:r};(()=>{let e,t;const n=e=>e>999?`${Math.round(e/1e3*100)/100}k`:`${e}`,r=e=>`${Math.round(100*e.value)/100} / ${n(e.maxValue)}`,a=e=>Math.round(game.getResourcePerTick(e.type,!0)*game.getTicksPerSecondUI()*100)/100,o=t=>{const n=e[t.type].maxValue,r=60*t.rate;let l=e[t.type].value+5*r,a=e[t.type].value+15*r;return l<0&&(l=0),a<0&&(a=0),[d3.min([l,n]),d3.min([a,n]),n]},i=({rate:e})=>e>0?`+${e}/s`:e<0?`${e}/s`:"0/s";!function(){const s=setInterval(()=>{try{e=game.resPool.resourceMap}catch(e){return}clearInterval(s),setTimeout(()=>{!function(){const s=document.createElement("div");s.setAttribute("id","ktns-button"),s.innerHTML='\n      <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAADsSURBVEhLYxhWIHjCmeboKec6sWHfvhNOUGXUB5FTz77ffuX9f3Q85/DT/6ETT0+FKqM+iJ9x4dX9D//+o+M9Nz6OWkxdQLTFvn2nrbGlQBAGpVCoMqIB0RZHTDnXAUpx2FIiKIVClRENSLIYJIhNMcgQqDKiwajFMDxq8eC32L/v1IWkWRefYMMgOagy6lscNunMDWxqQBgkB1U2ajEcj1o8ajEKHrUYmxoQHnoWE9P0ARmOTQ0II1tMdIPep+ekc/jkMzOw4aAJpyZBlTEE9J3Kx6YGhEFyUGUMID3Y1ICwV/cJb6iygQAMDABiLaLXLxFFNQAAAABJRU5ErkJggg==" />\n    ',document.body.appendChild(s);const c=document.createElement("div");c.setAttribute("id","ktns-hook"),document.body.appendChild(c);let u=!1;s.onclick=()=>{u?(d.selectAll("svg").remove(),u=!1,c.setAttribute("class","")):(t&&(clearInterval(t),t=null),x())};const d=d3.select("#ktns-hook"),b={top:5,right:100,bottom:20,left:100},g=440-b.left-b.right,p=50-b.top-b.bottom,m=d3.bullet().width(g).height(p).tickFormat(n);let f=gamePage.resPool.resources.filter(e=>e.maxValue>0&&!e.isHidden&&e.unlocked&&e.visible);const k=()=>f.map(({title:t,name:n})=>({title:t.charAt(0).toUpperCase()+t.substr(1).toLowerCase(),type:n,subtitle:r(e[n]),ranges:[0,0,e[n].maxValue],measures:[e[n].value,e[n].value],markers:[0],rate:a({type:n})}));setInterval(()=>{if(t&&u){const e=gamePage.resPool.resources.filter(e=>e.maxValue>0&&!e.isHidden&&e.unlocked&&e.visible);e.length!==f.length&&(clearInterval(t),f=e,d.selectAll("svg").remove(),x())}},1e3);let h=[];const A=()=>{gamePage.tabs[0].buttons.forEach(e=>{$(e.domNode).hover(()=>{h=e.model.prices},()=>{h=[]})})};A();const v=$("#gameContainerId")[0];function x(){c.setAttribute("class","active"),u=!0;const e=k(),n=d.selectAll("svg").data(e).enter().append("svg").attr("class","bullet").attr("width",g+b.left+b.right).attr("height",p+b.top+b.bottom).append("g").attr("transform","translate("+b.left+","+b.top+")").call(m),r=n.append("g").style("text-anchor","end").attr("transform","translate(-6,"+p/2+")"),a=n.append("g").attr("transform",`translate(${g+5},${p/2+1})`),o=()=>a.append("text").attr("class","rate").attr("fill",e=>e.rate>-1?l.colors.positive:l.colors.negative).text(i);o(),r.append("text").attr("class","title").text(function(e){return e.title});const s=()=>r.append("text").attr("class","subtitle").attr("dy","1em").text(function(e){return e.subtitle});s(),t=setInterval(()=>{n.datum(y).call(m.duration(400)),n.selectAll(".bullet .marker").attr("class",e=>`marker ${e>0?"selected":""}`),d.selectAll("svg").attr("class",e=>h.find(t=>t.name===e.type)?"bullet selected":"bullet"),r.selectAll(".subtitle").remove(),s(),a.selectAll(".rate").remove(),o()},400)}function y(t){t.subtitle=r(e[t.type]),t.measures=[e[t.type].value,e[t.type].value];const n=h.find(e=>e.name===t.type);return t.markers[0]=n?e[t.type].value-n.val<0?1:e[t.type].value-n.val:0,t.rate=a(t),t.ranges=o(t),t}new MutationObserver(e=>{for(let t of e)"childList"==t.type&&A()}).observe(v,{attributes:!0,childList:!0,subtree:!1}),x()}(),console.log("KTNS loaded")},300)},100)}()})()}]);